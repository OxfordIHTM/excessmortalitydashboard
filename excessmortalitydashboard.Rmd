---
title: "COVID-19 Excess Mortality"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code: https://github.com/OxfordIHTM/excessmortalitydashboard
    theme: cerulean
---

```{r setup, include=FALSE}
if(!require(flexdashboard)) install.packages("flexdashboard")
if(!require(remotes)) install.packages("remotes")
if(!require(shiny)) install.packages("shiny")
if(!require(dplyr)) install.packages("dplyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(leaflet)) install.packages("leaflet")
if(!require(ggmap)) install.packages("ggmap")

if(!require(okapi)) remotes::install_github("rapidsurveys/okapi")

mapbox.leShine   <- "https://api.mapbox.com/styles/v1/ernestguevarra/cjdlr8pvl0xiv2sqvq1evk1pl/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.satellite <- "https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.iceCream  <- "https://api.mapbox.com/styles/v1/ernestguevarra/cj81sytkq8z5g2spicbkd4hmx/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"

ona_auth_token(token = Sys.getenv("ONA_TOKEN"))

formid <- reactive({
  okapi::ona_list_data() %>%
    dplyr::filter(id_string == "mortalitymetadata") %>%
    dplyr::select(id)
})

metadata <- reactive({
  okapi::ona_get_data(form_id = formid())
})
```

Sidebar {.sidebar}
================================================================================

```{r}
output$country_selection <- renderUI({
  selectInput(
    inputId = "select_country",
    label = "Select country",
    choices = metadata()$`location/country`,
    selected = NULL
  )  
})

uiOutput("country_selection")
```

Summary
================================================================================

Row
--------------------------------------------------------------------------------

### Map

```{r map}
country_locations <- reactive({
  xxx <- metadata()$`location/country`
  ggmap::geocode(location = xxx)
})

output$map <- renderLeaflet({
  leaflet(options = leafletOptions(minZoom = 2)) %>%
    addTiles(
      urlTemplate = mapbox.leShine,
      attribution = "Map by <a href='https://www.mapbox.com/'>Mapbox</a>"
    ) %>%
    addMarkers(lng = country_locations()$lon,
               lat = country_locations()$lat,
               popup = metadata()$`location/country`) %>%
    setView(lng = 0, lat = 25, zoom = 2)
})

leafletOutput("map", height = "350px")
```

Row
--------------------------------------------------------------------------------

### Submissions {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = nrow(metadata()),
    caption = "Submissions",
    icon = "fa-database",
    color = "primary"
  )
})
```

### Countries {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = length(metadata()$`location/country`),
    caption = "Countries",
    icon = "fa-globe",
    color = "primary"
  )
})
```

Row { .tabset .tabset-fade }
--------------------------------------------------------------------------------

### Organisation

```{r}
output$organisation_text <- renderText({
  paste("Characteristics of organisation in ", input$select_country,
        " responsible for mortality data.")
})

h4(textOutput("organisation_text"))

organisation_profile <- reactive({
  req(input$select_country)
  y <- metadata()
  x <- y[y$`location/country` == input$select_country, ]
  
  organisation_type    <- ifelse(x$`organisation/organisation_type` == "ngo",
                                 "Non-governmental organisation",
                            ifelse(x$`organisation/organisation_type` == "uno", 
                                   "United Nations (UN) organisation",
                              ifelse(x$`organisation/organisation_type` == "gov",
                                     "Government", "Other")))
  organisation_name    <- x$`organisation/organisation_name`
  organisation_address <- x$`organisation/organisation_contact_address`
  organisation_phone   <- x$`organisation/organisation_contact_phone`
  organisation_email   <- x$`organisation/organisation_contact_email`
  organisation_website <- x$`organisation/organisation_contact_website`
  
  tab <- data.frame(c("Organisation Type", "Organisation Name", "Organisation Address",
                      "Organisation Phone", "Organisation Email", "Organisation Website"),
                    c(organisation_type, organisation_name, organisation_address,
                      organisation_phone, organisation_email, organisation_website))
  names(tab) <- c("Feature", "Characteristics")
  
  tab
})

output$table1 <- DT::renderDT({ organisation_profile() })


DT::DTOutput("table1")
```

Metadata
================================================================================

Row
--------------------------------------------------------------------------------

```{r}
output$metatable <- DT::renderDT({ metadata() })

DT::DTOutput("metatable")
```

