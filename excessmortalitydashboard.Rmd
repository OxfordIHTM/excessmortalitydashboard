---
title: "COVID-19 Excess Mortality"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code: https://github.com/OxfordIHTM/excessmortalitydashboard
    theme: cerulean
---

```{r setup, include=FALSE}
if(!require(flexdashboard)) install.packages("flexdashboard")
if(!require(remotes)) install.packages("remotes")
if(!require(shiny)) install.packages("shiny")
if(!require(dplyr)) install.packages("dplyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(leaflet)) install.packages("leaflet")
if(!require(ggmap)) install.packages("ggmap")

if(!require(okapi)) remotes::install_github("rapidsurveys/okapi")

mapbox.leShine   <- "https://api.mapbox.com/styles/v1/ernestguevarra/cjdlr8pvl0xiv2sqvq1evk1pl/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.satellite <- "https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.iceCream  <- "https://api.mapbox.com/styles/v1/ernestguevarra/cj81sytkq8z5g2spicbkd4hmx/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"

ona_auth_token(token = Sys.getenv("ONA_TOKEN"))

formid <- reactive({
  okapi::ona_list_data() %>%
    dplyr::filter(id_string == "mortalitymetadata") %>%
    dplyr::select(id)
})

metadata <- reactive({
  okapi::ona_get_data(form_id = formid())
})

update_metadata <- eventReactive(input$data_update, {
  okapi::ona_get_data(form_id = formid())
})

observe({
  if(nrow(update_metadata()) > nrow(metadata())) {
    metadata <- reactive({
      update_metadata()
    })
  }
})
```

Sidebar {.sidebar}
================================================================================

```{r}
br()

div(style="display:inline-block; vertical-align:middle; align:center",            
    actionButton(inputId = "data_update", label = "Update data",
                 class = "btn-primary"))
```

Summary
================================================================================

```{r map}
output$map <- renderLeaflet({
  leaflet() %>%
    addTiles(
      urlTemplate = 
    )
})
```


### Submissions {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = nrow(metadata()),
    caption = paste("No. of submissions as at ", Sys.Date(), sep = ""),
    icon = "fa-database",
    color = "primary"
  )
})
```

### Countries {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = nrow(metadata()),
    caption = paste("No. of submissions as at ", Sys.Date(), sep = ""),
    icon = "fa-database",
    color = "primary"
  )
})
```

### Countries {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = nrow(metadata()),
    caption = paste("No. of submissions as at ", Sys.Date(), sep = ""),
    icon = "fa-database",
    color = "primary"
  )
})
```

### Countries {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = nrow(metadata()),
    caption = paste("No. of submissions as at ", Sys.Date(), sep = ""),
    icon = "fa-database",
    color = "primary"
  )
})
```

### Countries {.value-box}

```{r}
renderValueBox({
  valueBox(
    value = nrow(metadata()),
    caption = paste("No. of submissions as at ", Sys.Date(), sep = ""),
    icon = "fa-database",
    color = "primary"
  )
})
```

Metadata
================================================================================

Row
--------------------------------------------------------------------------------

```{r}
output$metatable <- renderDataTable({ metadata()[[1]] })

DT::dataTableOutput("metatable")
```

